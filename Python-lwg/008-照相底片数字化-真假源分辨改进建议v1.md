# 照相底片数字版的当前任务总述与训练数据提取

Author: haoyanzhen
Date:   2025-03-10 至 2025-03-31

## work7思路整理

1. 通过补全fits关键字来得到底片的ra和dec范围，同时得到探测星表的icrs坐标
2. 使用SExtractor进行探测
3. 下载对应天区的Gaia星表，使用astropy对Gaia星表和SEx探测星表进行最近邻匹配，根据匹配结果打上标签
4. 提取每一个探测源的`8*8`图像，若图像尺寸不满`8*8`则通过pad补充全0白边
5. 以图像为输入，匹配结果为标签，使用cmpcmpfmf的CNN神经网络进行训练
   - (c: convolutional layer; m: motivation layer; p: pooling layer; f: full-connected layer)

## work7的改正建议

1. 补全fits关键字的过程可能有错误，建议重新检查关键字补全，或者使用`astrometry.net`来进行粗-细匹配来得到与底片匹配的真实星表
2. 匹配时除了使用`astropy.coordinates.match_coordinates_sky`做位置匹配之外，增加星等对比、1000*1000图像展示（或者用ds9来查看）等方式确保匹配正确
   - 星等对比： 在位置匹配之后按照近邻顺序依次比对星等是否接近
   - 三维匹配： 将星等加入匹配参数，使用`x,y,mag`三维参数进行最近邻搜寻，需注意数字量级对齐
   - 星表深度： 除了探测假源以外，也要注意星表深度问题，星等更深的星表中会出现大量无法匹配的星
   - 数据策略： 将无法匹配或无法确保正确的数据筛查掉不做使用
3. 数据提取
   - 没有必要因为`//2`导致的尺寸问题增加pad白边，而是需要在patch索引超出图像边界的时候增加pad白边，或者选择不适用边缘数据
   - 正负样本的数量应与权重匹配
   - 要分训练样本和测试样本
   - 归一化：判断有没有做归一化的需要，确定归一化正确。数据正则化-模型激活函数-标签，三者最好在量级上相互匹配
4. 模型
   - 训练和测试都放在显卡上跑
   - `batch_size`调高

## work7的完善建议

1. 在每一步不确定的地方增加一些展示，如绘图或统计
2. 看看每一个patch中是否存在其他源的干扰，决定对于存在多个源的patch数据是否需要筛除
3. 数据提取之后可以用dataloader进行打乱顺序
4. 模型conv的channels变化可以更平滑
5. 尝试其他CNN结构，如
   - ccpmcccpm
   - ccmccm
6. 尝试多层特征混合
7. 尝试将SEx星表信息作为共同输入混合到CNN中
8. 评价体系： 采用真假-正负的二维评价矩阵
   - 将判断错误的样本挑出来分析原因
