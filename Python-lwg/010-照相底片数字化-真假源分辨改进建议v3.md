# 照相底片数字版的相关技术点建议汇总

Author: haoyanzhen
Date:   2025-05-07 至 2025-05-30

与上次相比，在流程完整度上有所补充，但在数据预处理上还需要多下功夫，现在的数据一定有很多标签都是错的。
以下是对work9一些问题的观察和讨论：

## 数据集制作部分

1. 在Gaia星等-SEx流量拟合中，数据的平滑清洗方法似乎不适合，把有效的数据筛掉了，建议用拟合-数据与预期值偏离超过3sigma来剔除-拟合的迭代方式来，迭代2~3轮。
2. 星等-流量的弥散可能和星像在底片上的位置有关，可以试试在星等-流量图上用十六进制颜色表示每个星像的位置，红色度表示X蓝色度表示Y，看看弥散是否和位置有相关性。
3. 在3D匹配中，输入值alpha和beta是不是没有用到？这个三维匹配用的是X，Y和mag，这三者的权重是否相同？粗略的认为相同应该也行，不过按理来说在同等的信噪比条件下，mag的差异要比X或Y的小一点。在这里的3D匹配中，为什么没有对最大的distance做限制，这样的话实际上是假设每一个Gaia星都有一个图像对应，但实际上每一颗Gaia星是否会存在在图像上，这是不确定的，上一期中的图像对比也显示有些亮的真星在底片上是不存在的，因此这里仍然建议用sigma-clip方法剔除掉distance过于大的离群值。你看下面的calculate_magnitude_stats中，XYM_MATHCED=1里面的gaia-mag和calculated-mag的最大最小值都差那么多，那一定不算是正确的匹配
4. 在清洗后的数据的部分，展示describe的地方，为什么X_IMAGE的最小值为5372？按理来说一共有几万个数据，应该是从图像的最左边到最右边才对？是不是Gaia的星表没有覆盖整个底片？左侧的图中应该也有真源和假源，如果Gaia没有全覆盖的话，相当于左侧的图会全部被认定为假源，这问题就大了。
5. 在下面的'ANY_MATCHED'部分，使用了flux-mag-match和xym-match的任意组合，而这两个各有各的问题，前者问题更大，导致匹配的数据不对，数据不纯，相当于答案不对，结果当然是机器学习也不知道该怎么学了。
6. 在normalize_patch部分，减去背景之后+1e-3就可以保证全部为正数吗，那说明减去背景以后依然全部都是不小于-1e-3的数？那么背景是不是有点问题，直接用全图的data的中位数是否欠妥，如果星象较为密集的话，这里的中位数会比背景偏高许多，建议使用astropy.stats.sigma_clip，使用经过离散值剔除后的中位数作为背景的估计。
7. 在选取数据查看的部分，从采样出来的16x16的图像上来看，你能够用肉眼分辨出真假源吗？建议给每副imshow加一个colorbar来查看具体的数值。另外这幅图像的星象半高全宽是多少呢？尺寸为16是否太小了？选取几张图像来看倒是没必要随机选择，最好知道每张图的id，所以指定一个id往下排就可以。
8. 选取数据做数据集的时候，drop了ANY_MATCHED为na的部分，这一部分代表什么？SEx的探测星表应该不止训练样本的10876个才对，是有一部分（左侧的部分）没有匹配到吗？按理来说训练样本应该包含SEx的全部星表，只是从中挑选出真星作为正样本，假星作为负样本。
9. 为什么加了验证集之后就没有重采样了

## 训练部分

1. 从验证集的表现来看，epoch在4的时候就已经开始过拟合了，再训练模型也只会导致它的泛化性越来越差，所以在这种数据纯度下的最优训练loss就是0.9左右了。过拟合到验证集loss达到3.5，那是有点太夸张了，这个测都不用测，过拟合成这样等于没训练hhh
