# 照相底片数字版的相关技术点建议汇总

Author: haoyanzhen
Date:   2025-05-07 至 2025-05-30

这一次的数据处理相比上一次，在数据处理思考和流程完备上有了显著的提高，进步明显，继续加油！
以下从work74的回复中汇总一些可能影响数据处理结果的技术点建议。

## 数据集制作部分

常言道：“有了好的样本，就成功了一半”，样本必须足够纯净，才能训练出好的模型。

1. 在匹配阶段，要求位置最优匹配和星等差在1以内匹配同时满足，可能会带来以下问题：

   - 位置次优匹配而星等匹配的真样本被忽略（发生概率应该不大）
   - 对同一颗Gaia星，可能有多颗探测样本被匹配到，被认为是真源（在噪点假源密集的区域，发生概率较大）
   - 在暗弱部分，Gaia星匹配到的源为假源

    总而言之，如果出现匹配到的反而是假源，未匹配的反而是真源，则会给数据集增添很多伪样本，加大数据集的真假判别难度。
    就这个问题，建议仔细查看匹配之后的样本集，检测其正误。
    可以参考使用`x,y,mag`三维匹配，对位置和星等赋予不同的匹配权重，来尝试结果是否有所改善。

2. 另外，做星等-流量拟合时，选用的星等范围有点问题。不应依据Gaia的最亮星来选取底片的星等范围。
3. 此外，所使用的平滑清洗方法似乎将一些有效样本清洗掉了，这会造成一定的偏差。以及对分段点的判断和二次函数的窄小区间，会导致二次函数的外延误差问题。
4. 在数据集制作完成后，可以根据数据集的情况来选取正则化方法，如果选取不恰当的方法可能适得其反。在光学观测的流量图像中，不同星之间的流量差异极大，且暗星与背景非常贴近，因此，更推荐采用对整张底片扣除背景之后的流量图像进行log10变化，或者sqrt变化等等进行大数压缩的正则化方法。
5. 在提取图像patch时，星象中心落在以(8,8)为中心的上下左右各展宽0.5的方格内，即每一个星的坐标在(7.5,8.5)之间，根据CNN模型，在经过一次max pool后，其中心会变成(4,5)之间，两次max pool后，会变成(2,3)之间，相当于原本的中心反而变得模糊，且会在4x4的特征图上占据4个可能的特征像素，这不利于中心特征的提取。
6. 在训练之前，务必检查自己的数据集是否符合预期，标签是否正确。

## 训练部分

1. 用太多的正则化是不被建议的
2. 初始通道可以放入不同正则化的多张图像，如原始图像（所有图像均扣掉背景）+log10映射后的图像+sqrt映射后的图像，作为3通道输入
3. 在初始训练还未成功之前，dropout层是不被建议的，因为那主要是用来反过拟合，在拟合成功后存在过拟合问题时才会考虑
4. 在最后一层fc2层之前加0.5的doprout是非常具有破坏性的，加上前面的dropout，这表示每一次训练都有一半以上的模型是被随机废弃的，每两三次训练之间，几乎绝大部分模型都被废弃过，这会使得模型的收敛极不稳定，甚至无法收敛。dropout本身建议从0.1开始加，根据过拟合问题的严重程度和dropout的效果依序测试。
5. 这个CNN模型本质上是一个ccmpccmpcm-ff网络，在网络结构上还可以改进，可以测试不同宽度、深度的效果，以及多层特征融合的效果。
6. ff的神经元数量衰减太快了，建议更加平滑一些。
7. 学习率的衰减不太合理，正常的衰减是为了达到更深的极限，也就是模型在当前学习率下已经训练到了损失无法下降的程度，相当于在一个损失盆地里，每一步优化都会使得模型从半山腰的一个点跑到另一个点，因此才需要降低学习率来让模型能更接近谷底。所以学习率衰减一定是在当前学习率已经达到极限之后。根据上面对dropout的分析，这个模型会很难达到极限，因此需要大量的同等lr下的训练，最开始最好先不要进行学习率衰减，先测试初始学习率应该调成多少。根据你的训练损失曲线，损失下降的太慢了，当前的初始lr一定是偏小的。（注：通常的损失下降是指数形式的下降，损失函数会下降到原来的0.2以下，对数据优良复杂度低的任务甚至能下降到0.01）
8. 混合评估的意义有些难以判断，建议将训练集和测试集分开评估——训练集评估训练效果，测试集评估泛化能力（即模型学习到数据特征的处理并用于自身从未接触过的数据的能力）
